---
title: "ntl_east_drc"
author: "Mateus Berutto Figueiredo"
date: "2025-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## VIIRS NTL Data

Data were retrieved from the [EOG database](https://eogdata.mines.edu/products/vnl/). Data were initially collected by Suomi NPP satellite.

vcmcfg = VIIRS Cloud Masked, Stray Light Corrected, with filtering of ephemeral lights (fires, auroras, etc)

Files ending in `.cvg.tif` represent the coverage, the total number of days that contributed to each pixel.

Files endings in `.cf_cvg.tif` represent the total number of cloud-free days in the coverage. As such, `.cvg.tif` \>= `.cf_cvg.tif`.

Files ending in `.avg_rade9h_tif` re-resent the average radiance (nanoWatts/$\,\text{cm}^2$/sr)

## Loading necessary packages

```{r}
# Uncomment lines to download necessary packages
# install.packages("terra")
# install.packages("stringr")
# install.packages("tidyverse")
# install.packages("dplyr")

# Loading necessary packages
library(terra)
library(stringr)
library(tidyverse)
terraOptions(todisk = TRUE)
```

## Setting up

```{r}
# Open each file (change directory if needed)
avg_rade9h_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.avg_rade9h.tif")
cvg_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.cvg.tif")
cf_cvg_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.cf_cvg.tif")

avg_rade9h_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.avg_rade9h.tif")
cvg_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.cvg.tif")
cf_cvg_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.cf_cvg.tif")
```

## Adjusting for cloud-free pixels 

```{r}
# Setting minimum cloud-free nights to 10
min_cf <- 10

# Creating object wih only pixels with at least ten cloudless nights (other pixels left as NA)
avg_masked_00 <- ifel(cf_cvg_00N060W >= min_cf, avg_rade9h_00N060W, NA)
avg_masked_75 <- ifel(cf_cvg_75N060W >= min_cf, avg_rade9h_75N060W, NA)
```

## Merging tiles

```{r}
# Quick sanity check (VIIRS tiles usually already match)
stopifnot(crs(avg_masked_00) == crs(avg_masked_75))
stopifnot(all(res(avg_masked_00) == res(avg_masked_75)))

# Merge neighbors; average values in any overlap
ntl_mosaic <- mosaic(avg_masked_00, avg_masked_75, fun = "mean", na.rm = TRUE)

plot(ntl_mosaic, main = "Masked VIIRS mosaic")

```
