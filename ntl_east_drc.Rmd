---
title: "ntl_east_drc"
author: "Mateus Berutto Figueiredo"
date: "2025-09-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## VIIRS NTL Data

Data were retrieved from the [EOG database](https://eogdata.mines.edu/products/vnl/). Data were initially collected by Suomi NPP satellite.

vcmcfg = VIIRS Cloud Masked, Stray Light Corrected, with filtering of ephemeral lights (fires, auroras, etc)

Files ending in `.cvg.tif` represent the coverage, the total number of days that contributed to each pixel.

Files endings in `.cf_cvg.tif` represent the total number of cloud-free days in the coverage. As such, `.cvg.tif` \>= `.cf_cvg.tif`.

Files ending in `.avg_rade9h_tif` re-resent the average radiance (nanoWatts/$\,\text{cm}^2$/sr)

## Loading necessary packages

```{r}
# Uncomment lines to download necessary packages
# install.packages("terra")
# install.packages("stringr")
# install.packages("tidyverse")
# install.packages("dplyr")

# Loading necessary packages
library(terra)
library(stringr)
library(tidyverse)
terraOptions(todisk = TRUE)
```

## Setting up

```{r}
# Open each file (change directory if needed)
avg_rade9h_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.avg_rade9h.tif")
cvg_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.cvg.tif")
cf_cvg_00N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20250131_00N060W_vcmslcfg_v10_c202502181200.cf_cvg.tif")

avg_rade9h_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.avg_rade9h.tif")
cvg_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.cvg.tif")
cf_cvg_75N060W <- rast("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/SVDNB_npp_20250101-20251231_75N060W_vcmcfg_v10_c202502181200.cf_cvg.tif")

# Loading provinces shp file
gadm_cod1 <- vect("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/gadm41_COD_shp/gadm41_COD_1.shp")

# Loading village/territory shp file
gadm_cod2 <- vect("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/gadm41_COD_shp/gadm41_COD_2.shp")
```

## South Kivu

```{r}
# Selecting South Kivu 
south_kivu <- gadm_cod1[gadm_cod1$NAME_1 %in% c("Sud-Kivu", "South Kivu"), ]

# Align CRS
# Ensure shapefile matches VIIRS raster coordinate system (WGS84)
south_kivu_r <- project(south_kivu, crs(avg_rade9h_00N060W))

# Crop and mask rasters to South Kivu
# Crop = fast bounding box cut; mask = keep only pixels inside border
avg_sk <- mask(crop(avg_rade9h_00N060W, south_kivu_r), south_kivu_r)
cf_sk  <- mask(crop(cf_cvg_00N060W,     south_kivu_r), south_kivu_r)

# Apply cloud-free threshold
min_cf <- 5
avg_sk_masked <- ifel(cf_sk >= min_cf, avg_sk, NA_real_)

# Compute share of valid (non-NA) pixels
# Restrict calculation strictly to inside the province polygon
in_province   <- mask(cf_sk, south_kivu_r)
total_inside  <- global(!is.na(in_province), "sum", na.rm = TRUE)[1,1]
valid_inside  <- global(!is.na(avg_sk_masked), "sum", na.rm = TRUE)[1,1]
pct_valid_inside <- 100 * valid_inside / total_inside

cat(sprintf("South Kivu (inside borders only): %.2f%% valid pixels\n",
            pct_valid_inside))

# Diagnostics: NA mask map
plot(is.na(avg_sk_masked),
     main = "South Kivu – NA pixels (white = missing, black = valid)")

# Visualization: radiance map
plot(avg_sk_masked,
     col   = hcl.colors(100, "Inferno", rev = TRUE),
     NAcol = "transparent",
     main  = paste0("South Kivu – Night-time Light Radiance (min_cf ≥ ",
                    min_cf, ")"))
plot(south_kivu_r, add = TRUE, border = "white", lwd = 1.2)
```

## Goma

```{r}

# Subset the Goma territory / city
# Check naming with: unique(gadm_cod2$NAME_2)
goma <- gadm_cod2[gadm_cod2$NAME_2 %in% c("Goma", "Ville de Goma"), ]

# Align CRS with VIIRS raster (ensures same coordinate system)
goma_r <- project(goma, crs(avg_rade9h_00N060W))

# Crop and mask radiance + coverage to Goma
# Crop = cut by bounding box (faster)
# Mask = keep only pixels inside the territory boundary
avg_goma <- mask(crop(avg_rade9h_00N060W, goma_r), goma_r)
cf_goma  <- mask(crop(cf_cvg_00N060W,     goma_r), goma_r)

# Apply cloud-free threshold
min_cf <- 5
avg_goma_masked <- ifel(cf_goma >= min_cf, avg_goma, NA_real_)

# Compute % of valid (non-NA) pixels inside Goma polygon
in_goma      <- mask(cf_goma, goma_r)
total_inside <- global(!is.na(in_goma), "sum", na.rm = TRUE)[1,1]
valid_inside <- global(!is.na(avg_goma_masked), "sum", na.rm = TRUE)[1,1]
pct_valid_inside <- 100 * valid_inside / total_inside

cat(sprintf("Goma (inside borders only): %.2f%% valid pixels\n", pct_valid_inside))

# Diagnostic: NA-pixel map
plot(is.na(avg_goma_masked),
     main = "Goma – NA pixels (white = missing, black = valid)")

# Visualization: Radiance map
plot(avg_goma_masked,
     col   = hcl.colors(100, "Inferno", rev = TRUE),
     NAcol = "transparent",
     main  = paste0("Goma – Night-time Light Radiance (min_cf ≥ ", min_cf, ")"))
plot(goma_r, add = TRUE, border = "white", lwd = 1.5)

# Optional: export processed raster
writeRaster(avg_goma_masked,
            paste0("C:/Users/MBERUTTOFI/OneDrive - United Nations/Desktop/NTL-Eastern-DRC/jan2025/processed/",
                   "avg_goma_masked_cf", min_cf, ".tif"),
            overwrite = TRUE, gdal = c("COMPRESS=LZW"))
```
